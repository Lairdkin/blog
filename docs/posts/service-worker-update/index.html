<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³• - èåœç‚–é±¼ä¸¸</title><meta name="Description" content=""><meta property="og:title" content="[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•" />
<meta property="og:description" content="è½¬è½½ä¿¡æ¯ è½¬è‡ªï¼šæ˜é‡‘ by å°è˜‘è‡å“¥å“¥ ï¼ŒåŸæ ‡é¢˜ï¼šè°¨æ…å¤„ç† Service Worker çš„æ›´æ–° ä»Šå¤©è¦èŠçš„è¯é¢˜æ˜¯å‰ç«¯æœ€è¿‘çš„ä¸€ä¸ªæ›´æ–°æ–¹å‘ PWA ä¸­çš„æ ¸å¿ƒ Service Worker çš„æ›´æ–°é—®é¢˜ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“è¢«å¼€å‘è€…å¿½ç•¥çš„é—®é¢˜ï¼Œå› ä¸ºç»å¤§éƒ¨åˆ†å¼€å‘è€…å¯èƒ½å¯¹å®ƒè¿˜ä¸å¤ªç†Ÿæ‚‰ã€‚ Service Worker ä»¥å…¶ å¼‚æ­¥å®‰è£… å’Œ æŒç»­è¿è¡Œ ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå†³å®šäº†é’ˆå¯¹å®ƒçš„æ›´æ–°æ“ä½œå¿…é¡»éå¸¸è°¨æ…å°å¿ƒã€‚å› ä¸ºå®ƒå…·æœ‰æ‹¦æˆªå¹¶å¤„ç†ç½‘ç»œè¯·æ±‚çš„èƒ½åŠ›ï¼Œå› æ­¤å¿…é¡»åšåˆ°ç½‘é¡µ(ä¸»è¦æ˜¯å‘å‡ºå»çš„è¯·æ±‚)å’Œ Service Worker ç‰ˆæœ¬ä¸€è‡´æ‰" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://radish.cloud/posts/service-worker-update/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-09T21:50:22&#43;08:00" />
<meta property="article:modified_time" content="2021-06-09T21:50:22&#43;08:00" /><meta property="og:site_name" content="èåœç‚–é±¼ä¸¸" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•"/>
<meta name="twitter:description" content="è½¬è½½ä¿¡æ¯ è½¬è‡ªï¼šæ˜é‡‘ by å°è˜‘è‡å“¥å“¥ ï¼ŒåŸæ ‡é¢˜ï¼šè°¨æ…å¤„ç† Service Worker çš„æ›´æ–° ä»Šå¤©è¦èŠçš„è¯é¢˜æ˜¯å‰ç«¯æœ€è¿‘çš„ä¸€ä¸ªæ›´æ–°æ–¹å‘ PWA ä¸­çš„æ ¸å¿ƒ Service Worker çš„æ›´æ–°é—®é¢˜ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“è¢«å¼€å‘è€…å¿½ç•¥çš„é—®é¢˜ï¼Œå› ä¸ºç»å¤§éƒ¨åˆ†å¼€å‘è€…å¯èƒ½å¯¹å®ƒè¿˜ä¸å¤ªç†Ÿæ‚‰ã€‚ Service Worker ä»¥å…¶ å¼‚æ­¥å®‰è£… å’Œ æŒç»­è¿è¡Œ ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå†³å®šäº†é’ˆå¯¹å®ƒçš„æ›´æ–°æ“ä½œå¿…é¡»éå¸¸è°¨æ…å°å¿ƒã€‚å› ä¸ºå®ƒå…·æœ‰æ‹¦æˆªå¹¶å¤„ç†ç½‘ç»œè¯·æ±‚çš„èƒ½åŠ›ï¼Œå› æ­¤å¿…é¡»åšåˆ°ç½‘é¡µ(ä¸»è¦æ˜¯å‘å‡ºå»çš„è¯·æ±‚)å’Œ Service Worker ç‰ˆæœ¬ä¸€è‡´æ‰"/>
<meta name="application-name" content="RadishCloud">
<meta name="apple-mobile-web-app-title" content="RadishCloud"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><script src='/js/nprogress.js'></script>
<link rel='stylesheet' href='/css/nprogress.css'/><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/manifest.json"><link rel="canonical" href="https://radish.cloud/posts/service-worker-update/" /><link rel="prev" href="https://radish.cloud/posts/anhlaidh%E7%9A%84java%E7%AC%94%E8%AE%B01/" /><link rel="next" href="https://radish.cloud/posts/ff14-cartoon/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/radish.cloud\/posts\/service-worker-update\/"
        },"genre": "posts","keywords": "service worker, pwa","wordcount":  4740 ,
        "url": "https:\/\/radish.cloud\/posts\/service-worker-update\/","datePublished": "2021-06-09T21:50:22+08:00","dateModified": "2021-06-09T21:50:22+08:00","publisher": {
            "@type": "Organization",
            "name": "èåœç‚–é±¼ä¸¸"},"author": {
                "@type": "Person",
                "name": "èåœç‚–é±¼ä¸¸"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="èåœç‚–é±¼ä¸¸">èåœç‚–é±¼ä¸¸</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/categories/"> åˆ†ç±» </a><a class="menu-item" href="/weibo/" title="å°å£°BB"> å¾®è¨€ </a><a class="menu-item" href="/bangumi/" title="ç•ªå‰§åˆ—è¡¨"> è¿½ç•ª </a><a class="menu-item" href="/about/"> å…³äº </a><a class="menu-item" href="/links/"> å‹æƒ…é“¾æ¥ </a><a class="menu-item" href="https://github.com/Lairdkin/blog" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><a class="menu-item" href="https://status.radish.cloud" title="æœåŠ¡çŠ¶æ€" rel="noopener noreffer" target="_blank"><i class='fas fa-server'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/posts/service-worker-update/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="èåœç‚–é±¼ä¸¸">èåœç‚–é±¼ä¸¸</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="æœç´¢">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="æ¸…ç©º">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        å–æ¶ˆ
                    </a>
                </div><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">åˆ†ç±»</a><a class="menu-item" href="/weibo/" title="å°å£°BB">å¾®è¨€</a><a class="menu-item" href="/bangumi/" title="ç•ªå‰§åˆ—è¡¨">è¿½ç•ª</a><a class="menu-item" href="/about/" title="">å…³äº</a><a class="menu-item" href="/links/" title="">å‹æƒ…é“¾æ¥</a><a class="menu-item" href="https://github.com/Lairdkin/blog" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a class="menu-item" href="https://status.radish.cloud" title="æœåŠ¡çŠ¶æ€" rel="noopener noreffer" target="_blank"><i class='fas fa-server'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="é€‰æ‹©è¯­è¨€">ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/posts/service-worker-update/" selected>ç®€ä½“ä¸­æ–‡</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
    <h2 class="toc-title">ç›®å½•</h2>
    <div class="toc-content" id="toc-content-auto"></div>
</div><article class="page single"><h1 class="single-title animated flipInX">[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•</h1><div class="post-meta">
        <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>èåœç‚–é±¼ä¸¸</a></span>&nbsp;<span class="post-category">æ”¶å½•äº <a href="/categories/%E5%89%8D%E7%AB%AF%E7%AC%94%E8%AE%B0/"><i class="far fa-folder fa-fw"></i>å‰ç«¯ç¬”è®°</a></span></div>
        <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-06-09">2021-06-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 4740 å­—&nbsp;
            <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 10 åˆ†é’Ÿ&nbsp;<span id="/posts/service-worker-update/" class="leancloud_visitors" data-flag-title="[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•">
                <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
            </span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" kept="">
        <div class="details-summary toc-title">
            <span>ç›®å½•</span>
            <span><i class="details-icon fas fa-angle-right"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#ç»„ç»‡-sw-çš„ä¸¤å¤§ç¦å¿Œ">ç»„ç»‡ SW çš„ä¸¤å¤§ç¦å¿Œ</a>
      <ul>
        <li><a href="#ä¸è¦ç»™-service-workerjs-è®¾ç½®ä¸åŒçš„åå­—">ä¸è¦ç»™ service-worker.js è®¾ç½®ä¸åŒçš„åå­—</a></li>
        <li><a href="#ä¸è¦ç»™-service-workerjs-è®¾ç½®ç¼“å­˜">ä¸è¦ç»™ service-worker.js è®¾ç½®ç¼“å­˜</a></li>
      </ul>
    </li>
    <li><a href="#sw-çš„-waiting-çŠ¶æ€">SW çš„ waiting çŠ¶æ€</a></li>
    <li><a href="#æ–¹æ³•ä¸€skipwaiting">æ–¹æ³•ä¸€ï¼šskipWaiting</a></li>
    <li><a href="#æ–¹æ³•äºŒskipwaiting--åˆ·æ–°">æ–¹æ³•äºŒï¼šskipWaiting + åˆ·æ–°</a>
      <ul>
        <li><a href="#sw-çš„æ›´æ–°å’Œé¡µé¢çš„åˆ·æ–°">SW çš„æ›´æ–°å’Œé¡µé¢çš„åˆ·æ–°</a></li>
        <li><a href="#é¿å…æ— é™åˆ·æ–°">é¿å…æ— é™åˆ·æ–°</a></li>
      </ul>
    </li>
    <li><a href="#æ–¹æ³•ä¸‰ç»™ç”¨æˆ·ä¸€ä¸ªæç¤º">æ–¹æ³•ä¸‰ï¼šç»™ç”¨æˆ·ä¸€ä¸ªæç¤º</a></li>
    <li><a href="#æ–¹æ³•ä¸‰çš„å¼Šç«¯">æ–¹æ³•ä¸‰çš„å¼Šç«¯</a>
      <ul>
        <li><a href="#å¼Šç«¯ä¸€è¿‡äºå¤æ‚">å¼Šç«¯ä¸€ï¼šè¿‡äºå¤æ‚</a></li>
        <li><a href="#å¼Šç«¯äºŒå¿…é¡»é€šè¿‡-js-å®Œæˆæ›´æ–°">å¼Šç«¯äºŒï¼šå¿…é¡»é€šè¿‡ JS å®Œæˆæ›´æ–°</a></li>
      </ul>
    </li>
    <li><a href="#åè®°">åè®°</a></li>
    <li><a href="#å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </a></li>
  </ul>
</nav></div>
    </div><div class="content" id="content">
        <div class="details admonition tip open">
            <div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>å‹æƒ…æç¤º<i
                    class="details-icon fas fa-angle-right fa-fw"></i></div>
            <div class="details-content">
                <div class="admonition-content">ğŸ“Œæç¤ºï¼šæƒ³è·å¾—ç¬¬ä¸€æ‰‹æ›´æ–°ï¼ŸåŠ å…¥<i class="fab fa-telegram-plane"></i> <a
                        href="https://t.me/radishkin_blog">Telegram é¢‘é“</a>è·å¾—åšå®¢æ›´æ–°æ¨é€ï¼Œæˆ–è€…ç‚¹å‡»é¡µé¢ <i class="fas fa-rss"></i>
                    æŒ‰é’®è®¢é˜…åšå®¢</div>
            </div>
        </div><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>è½¬è½½ä¿¡æ¯<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">è½¬è‡ªï¼š<a href="https://juejin.cn/post/6844903792522035208" target="_blank" rel="noopener noreffer">æ˜é‡‘ by å°è˜‘è‡å“¥å“¥</a> ï¼ŒåŸæ ‡é¢˜ï¼šè°¨æ…å¤„ç† Service Worker çš„æ›´æ–°</div>
        </div>
    </div>
<p>ä»Šå¤©è¦èŠçš„è¯é¢˜æ˜¯å‰ç«¯æœ€è¿‘çš„ä¸€ä¸ªæ›´æ–°æ–¹å‘ PWA ä¸­çš„æ ¸å¿ƒ Service Worker çš„æ›´æ–°é—®é¢˜ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“è¢«å¼€å‘è€…å¿½ç•¥çš„é—®é¢˜ï¼Œå› ä¸ºç»å¤§éƒ¨åˆ†å¼€å‘è€…å¯èƒ½å¯¹å®ƒè¿˜ä¸å¤ªç†Ÿæ‚‰ã€‚</p>
<blockquote>
<p>Service Worker ä»¥å…¶ <strong>å¼‚æ­¥å®‰è£…</strong> å’Œ <strong>æŒç»­è¿è¡Œ</strong> ä¸¤ä¸ªç‰¹ç‚¹ï¼Œå†³å®šäº†é’ˆå¯¹å®ƒçš„æ›´æ–°æ“ä½œå¿…é¡»éå¸¸è°¨æ…å°å¿ƒã€‚å› ä¸ºå®ƒå…·æœ‰æ‹¦æˆªå¹¶å¤„ç†ç½‘ç»œè¯·æ±‚çš„èƒ½åŠ›ï¼Œå› æ­¤å¿…é¡»åšåˆ°ç½‘é¡µ(ä¸»è¦æ˜¯å‘å‡ºå»çš„è¯·æ±‚)å’Œ Service Worker ç‰ˆæœ¬ä¸€è‡´æ‰è¡Œï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ–°ç‰ˆæœ¬çš„ Service Worker å¤„ç†æ—§ç‰ˆæœ¬çš„ç½‘é¡µï¼Œæˆ–è€…ä¸€ä¸ªç½‘é¡µå…ˆåç”±ä¸¤ä¸ªç‰ˆæœ¬çš„ Service Worker æ§åˆ¶å¼•å‘ç§ç§é—®é¢˜ã€‚</p>
</blockquote>
<p>ç»è¿‡è¿‘ 2 å¹´çš„å‘å±•ï¼ŒPWA åœ¨ WEB åœˆçš„çŸ¥ååº¦å·²ç»å¤§å¤§æå‡ï¼Œå³ä¾¿ä½ æ²¡ç”¨è¿‡å¯èƒ½ä¹Ÿè‡³å°‘å¬è¯´è¿‡ã€‚Service Worker ï¼ˆä»¥ä¸‹ç®€ç§° SWï¼‰æ˜¯ PWA ä¸­æœ€å¤æ‚æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå…¶ä¸­æ¶‰åŠçš„ä¸»è¦æœ‰ Caches API (<code>caches.put</code>, <code>caches.addAll</code> ç­‰), Service Worker API (<code>self.addEventListener</code>, <code>self.skipWaiting</code> ç­‰) å’Œ Registration API (<code>reg.installing</code>, <code>reg.onupdatefound</code> ç­‰)ã€‚</p>
<p>æœ¬æ–‡ä¸å†ç§‘æ™® SW çš„åŸºç¡€ï¼Œæˆ‘ä¸»è¦æƒ³åœ¨è¿™é‡Œè°ˆä¸€è°ˆ SW çš„æ›´æ–°é—®é¢˜ã€‚éœ€è¦åšåˆ° SW å’Œé¡µé¢çš„å®Œå…¨åŒæ­¥ï¼Œå…¶å®å¹¶ä¸å®¹æ˜“ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘å‡è®¾ä½ å·²ç»äº†è§£äº†ï¼š</p>
<ol>
<li>SW çš„ä½œç”¨</li>
<li>SW çš„æ³¨å†Œæ–¹å¼ (<code>navigator.serviceWorker.register</code>)</li>
<li>SW çš„ç”Ÿå‘½å‘¨æœŸ (install -&gt; waiting -&gt; activate -&gt; fetch)</li>
</ol>
<h2 id="ç»„ç»‡-sw-çš„ä¸¤å¤§ç¦å¿Œ">ç»„ç»‡ SW çš„ä¸¤å¤§ç¦å¿Œ</h2>
<p>åœ¨å¼€å§‹æ­£å¼è°ˆè®º SW çš„æ›´æ–°æœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆç¡®å®šç»„ç»‡ SW æ—¶çš„ä¸¤ä¸ªç¦å¿Œã€‚åœ¨å°† SW åº”ç”¨åˆ°è‡ªå·±çš„ç«™ç‚¹æ—¶ï¼Œæˆ‘ä»¬è¦é¿å¼€è¿™ä¸¤ç§æ–¹æ³•ï¼Œä»–ä»¬æ˜¯ï¼š</p>
<h3 id="ä¸è¦ç»™-service-workerjs-è®¾ç½®ä¸åŒçš„åå­—">ä¸è¦ç»™ service-worker.js è®¾ç½®ä¸åŒçš„åå­—</h3>
<p>ä¸€èˆ¬é’ˆå¯¹é™æ€æ–‡ä»¶ï¼Œæ—¶ä¸‹æµè¡Œçš„åšæ³•æ˜¯åœ¨æ¯æ¬¡æ„å»ºæ—¶æ ¹æ®å†…å®¹ï¼ˆæˆ–è€…å½“æ—¶çš„æ—¶é—´ç­‰éšæœºå› ç´ ï¼‰ç»™å®ƒä»¬ä¸€ä¸ªå”¯ä¸€çš„å‘½åï¼Œä¾‹å¦‚ <code>index.[hash].js</code>ã€‚å› ä¸ºè¿™äº›æ–‡ä»¶ä¸å¸¸ä¿®æ”¹ï¼Œå†é…ä»¥é•¿æ—¶é—´çš„å¼ºåˆ¶ç¼“å­˜ï¼Œèƒ½å¤Ÿå¤§å¤§é™ä½è®¿é—®å®ƒä»¬çš„è€—æ—¶ã€‚</p>
<p>å¯æƒœé’ˆå¯¹ SWï¼Œè¿™ç§åšæ³•å¹¶ä¸åˆé€‚ã€‚æˆ‘ä»¬å‡è®¾ä¸€ä¸ªé¡¹ç›®</p>
<ol>
<li>é¦–é¡µ <code>index.html</code>ï¼Œåº•ä¸‹åŒ…å«äº†ä¸€æ®µ <code>&lt;script&gt;</code> ç”¨äºæ³¨å†Œ <code>service-worker.v1.js</code>ã€‚</li>
<li>ä¸ºäº†æå‡é€Ÿåº¦æˆ–è€…ç¦»çº¿å¯ç”¨ï¼Œè¿™ä¸ª <code>service-worker.v1.js</code> ä¼šæŠŠ <code>index.html</code> ç¼“å­˜èµ·æ¥ã€‚</li>
<li>æŸæ¬¡å‡çº§æ›´æ–°ä¹‹åï¼Œç°åœ¨ <code>index.html</code> éœ€è¦é…ä¸Š <code>service-worker.v2.js</code> ä½¿ç”¨äº†ï¼Œæ‰€ä»¥æºç ä¸­åº•ä¸‹çš„ <code>&lt;script&gt;</code> ä¸­ä¿®æ”¹äº†æ³¨å†Œçš„åœ°å€ã€‚</li>
<li>ä½†æˆ‘ä»¬å‘ç°ï¼Œç”¨æˆ·è®¿é—®ç«™ç‚¹æ—¶ç”±äºæ—§ç‰ˆ <code>service-worker.v1.js</code> çš„ä½œç”¨ï¼Œä»ç¼“å­˜ä¸­å–å‡ºçš„ <code>index.html</code> å¼•ç”¨çš„ä¾ç„¶æ˜¯ <code>v1</code>ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬å‡çº§åå¼•ç”¨ <code>v2</code>ã€‚</li>
</ol>
<p>ä¹‹æ‰€ä»¥å‡ºç°è¿™ç§æƒ…å†µï¼Œæ˜¯å› ä¸ºæŠŠ <code>v1</code> å‡çº§ä¸º <code>v2</code> ä¾èµ–äº <code>index.html</code> å¼•ç”¨åœ°å€çš„å˜åŒ–ï¼Œä½†å®ƒæœ¬èº«å´è¢«ç¼“å­˜äº†èµ·æ¥ã€‚ä¸€æ—¦åˆ°è¾¾è¿™ç§çª˜å¢ƒï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ï¼Œå¸è½½ <code>v1</code>ï¼Œå¦åˆ™æˆ‘ä»¬æ— èƒ½ä¸ºåŠ›ã€‚</p>
<p><strong>æ‰€ä»¥ <code>service-worker.js</code> å¿…é¡»ä½¿ç”¨ç›¸åŒçš„åå­—ï¼Œä¸èƒ½åœ¨æ–‡ä»¶åä¸ŠåŠ ä¸Šä»»ä½•ä¼šæ”¹å˜çš„å› ç´ ã€‚</strong></p>
<h3 id="ä¸è¦ç»™-service-workerjs-è®¾ç½®ç¼“å­˜">ä¸è¦ç»™ service-worker.js è®¾ç½®ç¼“å­˜</h3>
<p>ç†ç”±å’Œç¬¬ä¸€ç‚¹ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢åœ¨æµè§ˆå™¨éœ€è¦è¯·æ±‚æ–°ç‰ˆæœ¬çš„ SW æ—¶ï¼Œå› ä¸ºç¼“å­˜çš„å¹²æ‰°è€Œæ— æ³•å®ç°ã€‚æ¯•ç«Ÿæˆ‘ä»¬ä¸èƒ½è¦æ±‚ç”¨æˆ·å»æ¸…é™¤ç¼“å­˜ã€‚å› æ­¤ç»™ SW åŠç›¸å…³çš„ JS (ä¾‹å¦‚ <code>sw-register.js</code>ï¼Œå¦‚æœç‹¬ç«‹å‡ºæ¥çš„è¯)è®¾ç½® <code>Cache-control: no-store</code> æ˜¯æ¯”è¾ƒå®‰å…¨çš„ã€‚</p>
<h2 id="sw-çš„-waiting-çŠ¶æ€">SW çš„ waiting çŠ¶æ€</h2>
<p>æ³¨å†Œ SW æ˜¯é€šè¿‡ <code>navigator.serviceWorker.register(swUrl, options)</code> æ–¹æ³•è¿›è¡Œçš„ã€‚ä½†å’Œæ™®é€šçš„ JS ä»£ç ä¸åŒï¼Œè¿™å¥æ‰§è¡Œåœ¨æµè§ˆå™¨çœ‹æ¥å…¶å®æœ‰ä¸¤ç§ä¸åŒçš„æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœç›®å‰å°šæœªæœ‰æ´»è·ƒçš„ SW ï¼Œé‚£å°±ç›´æ¥å®‰è£…å¹¶æ¿€æ´»ã€‚</li>
<li>å¦‚æœå·²æœ‰ SW å®‰è£…ç€ï¼Œå‘æ–°çš„ <code>swUrl</code> å‘èµ·è¯·æ±‚ï¼Œè·å–å†…å®¹å’Œå’Œå·²æœ‰çš„ SW æ¯”è¾ƒã€‚å¦‚æ²¡æœ‰å·®åˆ«ï¼Œåˆ™ç»“æŸå®‰è£…ã€‚å¦‚æœ‰å·®åˆ«ï¼Œåˆ™å®‰è£…æ–°ç‰ˆæœ¬çš„ SWï¼ˆæ‰§è¡Œ <code>install</code> é˜¶æ®µï¼‰ï¼Œä¹‹åä»¤å…¶ç­‰å¾…ï¼ˆè¿›å…¥ <code>waiting</code> é˜¶æ®µï¼‰</li>
</ul>
<p>æ­¤æ—¶å½“å‰é¡µé¢ä¼šæœ‰ä¸¤ä¸ª SWï¼Œä½†çŠ¶æ€ä¸åŒï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://user-gold-cdn.xitu.io/2019/3/8/1695b072d666761f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"
        data-srcset="https://user-gold-cdn.xitu.io/2019/3/8/1695b072d666761f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1, https://user-gold-cdn.xitu.io/2019/3/8/1695b072d666761f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 1.5x, https://user-gold-cdn.xitu.io/2019/3/8/1695b072d666761f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 2x"
        data-sizes="auto"
        alt="https://user-gold-cdn.xitu.io/2019/3/8/1695b072d666761f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"
        title="ä¸¤ä¸ª SW åŒæ—¶å­˜åœ¨" /></p>
<ul>
<li>å¦‚æœè€çš„ SW æ§åˆ¶çš„æ‰€æœ‰é¡µé¢ <strong>å…¨éƒ¨å…³é—­</strong>ï¼Œåˆ™è€çš„ SW ç»“æŸè¿è¡Œï¼Œè½¬è€Œæ¿€æ´»æ–°çš„ SWï¼ˆæ‰§è¡Œ <code>activated</code> é˜¶æ®µï¼‰ï¼Œä½¿ä¹‹æ¥ç®¡é¡µé¢ã€‚</li>
</ul>
<p>è¿™æ˜¯ä¸€ç§æ¯”è¾ƒæ¸©å’Œå’Œå®‰å…¨çš„åšæ³•ï¼Œç›¸å½“äºæ–°æ—§ç‰ˆæœ¬çš„è‡ªç„¶æ·˜æ±°ã€‚ä½†æ¯•ç«Ÿå…³é—­æ‰€æœ‰é¡µé¢æ˜¯ç”¨æˆ·çš„é€‰æ‹©è€Œä¸æ˜¯ç¨‹åºå‘˜èƒ½æ§åˆ¶çš„ã€‚å¦å¤–æˆ‘ä»¬è¿˜éœ€æ³¨æ„ä¸€ç‚¹ï¼šç”±äºæµè§ˆå™¨çš„å†…éƒ¨å®ç°åŸç†ï¼Œå½“é¡µé¢åˆ‡æ¢æˆ–è€…è‡ªèº«åˆ·æ–°æ—¶ï¼Œæµè§ˆå™¨æ˜¯ç­‰åˆ°æ–°çš„é¡µé¢å®Œæˆæ¸²æŸ“ä¹‹åå†é”€æ¯æ—§çš„é¡µé¢ã€‚è¿™è¡¨ç¤ºæ–°æ—§ä¸¤ä¸ªé¡µé¢ä¸­é—´æœ‰å…±åŒå­˜åœ¨çš„äº¤å‰æ—¶é—´ï¼Œ<strong>å› æ­¤ç®€å•çš„åˆ‡æ¢é¡µé¢æˆ–è€…åˆ·æ–°æ˜¯ä¸èƒ½ä½¿å¾— SW è¿›è¡Œæ›´æ–°çš„</strong>ï¼Œè€çš„ SW ä¾ç„¶æ¥ç®¡é¡µé¢ï¼Œæ–°çš„ SW ä¾ç„¶åœ¨ç­‰å¾…ã€‚ï¼ˆè¿™ç‚¹ä¹Ÿè¦æ±‚æˆ‘ä»¬åœ¨æ£€æµ‹ SW æ›´æ–°æ—¶ï¼Œé™¤äº† <code>onupdatefound</code> ä¹‹å¤–ï¼Œè¿˜éœ€è¦åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¤„åœ¨ç­‰å¾…çŠ¶æ€çš„ SWï¼Œå³ <code>reg.waiting</code> æ˜¯å¦å­˜åœ¨ã€‚ä¸è¿‡è¿™åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å¤–ï¼Œå°±ä¸å±•å¼€äº†ï¼‰</p>
<p>å‡è®¾æˆ‘ä»¬æä¾›äº†ä¸€æ¬¡é‡å¤§å‡çº§ï¼Œå¸Œæœ›æ–°çš„ SW å°½å¿«æ¥ç®¡é¡µé¢ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<h2 id="æ–¹æ³•ä¸€skipwaiting">æ–¹æ³•ä¸€ï¼šskipWaiting</h2>
<p>åœ¨é­é‡çªå‘æƒ…å†µæ—¶ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°é€šè¿‡â€œæ’é˜Ÿâ€çš„æ–¹å¼æ¥è§£å†³é—®é¢˜ï¼Œç°å®ç”Ÿæ´»ä¸­çš„æ•‘æŠ¤è½¦æ¶ˆé˜²è½¦ç­‰ç‰¹ç§è½¦è¾†å°±é‡‡ç”¨äº†è¿™ç§æ–¹æ¡ˆã€‚SW ä¹Ÿç»™ç¨‹åºå‘˜æä¾›äº†å®ç°è¿™ç§æ–¹æ¡ˆçš„å¯èƒ½æ€§ï¼Œé‚£å°±æ˜¯åœ¨ SW å†…éƒ¨çš„ <code>self.skipWaiting()</code> æ–¹æ³•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">self.addEventListener(&#39;install&#39;, event =&gt; {
  self.skipWaiting()
  // é¢„ç¼“å­˜å…¶ä»–é™æ€å†…å®¹
})
å¤åˆ¶ä»£ç 
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·å¯ä»¥è®©æ–°çš„ SW â€œæ’é˜Ÿâ€ï¼Œå¼ºåˆ¶ä»¤å®ƒç«‹åˆ»å–ä»£è€çš„ SW æ§åˆ¶æ‰€æœ‰é¡µé¢ï¼Œè€Œè€çš„ SW è¢«â€œæ–©ç«‹å†³â€ï¼Œç®€å•ç²—æš´ã€‚Lavas æœ€åˆå°±ä½¿ç”¨äº†è¿™ä¸ªæ–¹æ¡ˆï¼Œå› ä¸ºå®åœ¨æ˜¯å¤ªå®¹æ˜“æƒ³åˆ°ä¹Ÿå¤ªå®¹æ˜“å®ç°äº†ï¼Œè¯±æƒ‘æå¤§ã€‚</p>
<p>å¯æƒœè¿™ä¸ªæ–¹æ¡ˆæ˜¯æœ‰éšæ‚£çš„ã€‚æˆ‘ä»¬æƒ³è±¡å¦‚ä¸‹åœºæ™¯ï¼š</p>
<ol>
<li>ä¸€ä¸ªé¡µé¢ <code>index.html</code> å·²å®‰è£…äº† <code>sw.v1.js</code> ï¼ˆå®é™…åœ°å€éƒ½æ˜¯ <code>sw.js</code>ï¼Œåªæ˜¯ä¸ºäº†æ˜æ˜¾åŒºåˆ†å¦‚æ­¤è¡¨è¾¾è€Œå·²ï¼‰</li>
<li>ç”¨æˆ·æ‰“å¼€è¿™ä¸ªé¡µé¢ï¼Œæ‰€æœ‰ç½‘ç»œè¯·æ±‚éƒ½é€šè¿‡äº† <code>sw.v1.js</code>ï¼Œé¡µé¢åŠ è½½å®Œæˆã€‚</li>
<li>å› ä¸º SW å¼‚æ­¥å®‰è£…çš„ç‰¹æ€§ï¼Œä¸€èˆ¬åœ¨æµè§ˆå™¨ç©ºé—²æ—¶ï¼Œä»–ä¼šå»æ‰§è¡Œé‚£å¥ <code>navigator.serviceWorker.register</code>ã€‚è¿™æ—¶å€™æµè§ˆå™¨å‘ç°äº†æœ‰ä¸ª <code>sw.v2.js</code> å­˜åœ¨ï¼Œäºæ˜¯å®‰è£…å¹¶è®©ä»–ç­‰å¾…ã€‚</li>
<li>ä½†å› ä¸º <code>sw.v2.js</code> åœ¨ <code>install</code> é˜¶æ®µæœ‰ <code>self.skipWaiting()</code>ï¼Œæ‰€ä»¥æµè§ˆå™¨å¼ºåˆ¶é€€ä¼‘äº† <code>sw.v1</code>ï¼Œè€Œæ˜¯è®© <code>sw.v2</code> é©¬ä¸Šæ¿€æ´»å¹¶æ§åˆ¶é¡µé¢ã€‚</li>
<li>ç”¨æˆ·åœ¨è¿™ä¸ª <code>index.html</code> çš„åç»­æ“ä½œå¦‚æœ‰ç½‘ç»œè¯·æ±‚ï¼Œå°±ç”± <code>sw.v2.js</code> å¤„ç†äº†ã€‚</li>
</ol>
<p>å¾ˆæ˜æ˜¾ï¼ŒåŒä¸€ä¸ªé¡µé¢ï¼Œå‰åŠéƒ¨åˆ†çš„è¯·æ±‚æ˜¯ç”± <code>sw.v1.js</code> æ§åˆ¶ï¼Œè€ŒååŠéƒ¨åˆ†æ˜¯ç”± <code>sw.v2.js</code> æ§åˆ¶ã€‚è¿™ä¸¤è€…çš„ä¸ä¸€è‡´æ€§å¾ˆå®¹æ˜“å¯¼è‡´é—®é¢˜ï¼Œç”šè‡³ç½‘é¡µæŠ¥é”™å´©æºƒã€‚æ¯”å¦‚è¯´ <code>sw.v1.js</code> é¢„ç¼“å­˜äº†ä¸€ä¸ª <code>v1/image.png</code>ï¼Œè€Œå½“ <code>sw.v2.js</code> æ¿€æ´»æ—¶ï¼Œé€šå¸¸ä¼šåˆ é™¤è€ç‰ˆæœ¬çš„é¢„ç¼“å­˜ï¼Œè½¬è€Œæ·»åŠ ä¾‹å¦‚ <code>v2/image.png</code> çš„ç¼“å­˜ã€‚æ‰€ä»¥è¿™æ—¶å¦‚æœç”¨æˆ·ç½‘ç»œç¯å¢ƒä¸ç•…æˆ–è€…æ–­ç½‘ï¼Œæˆ–è€…é‡‡ç”¨çš„æ˜¯ CacheFirst ä¹‹ç±»çš„ç¼“å­˜ç­–ç•¥æ—¶ï¼Œæµè§ˆå™¨å‘ç° <code>v1/image.png</code> å·²ç»åœ¨ç¼“å­˜ä¸­æ‰¾ä¸åˆ°äº†ã€‚å³ä¾¿ç½‘ç»œç¯å¢ƒæ­£å¸¸ï¼Œæµè§ˆå™¨ä¹Ÿå¾—å†å‘ä¸€æ¬¡è¯·æ±‚å»è·å–è¿™äº›æœ¬å·²ç»ç¼“å­˜è¿‡çš„èµ„æºï¼Œæµªè´¹äº†æ—¶é—´å’Œå¸¦å®½ã€‚å†è€…ï¼Œè¿™ç±» SW å¼•å‘çš„é”™è¯¯å¾ˆéš¾å¤ç°ï¼Œä¹Ÿå¾ˆéš¾ DEBUGï¼Œç»™ç¨‹åºæ·»åŠ äº†ä¸ç¨³å®šå› ç´ ã€‚</p>
<p><strong>é™¤éä½ èƒ½ä¿è¯åŒä¸€ä¸ªé¡µé¢åœ¨ä¸¤ä¸ªç‰ˆæœ¬çš„ SW ç›¸ç»§å¤„ç†çš„æƒ…å†µä¸‹ä¾ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œæ‰èƒ½ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆã€‚</strong></p>
<h2 id="æ–¹æ³•äºŒskipwaiting--åˆ·æ–°">æ–¹æ³•äºŒï¼šskipWaiting + åˆ·æ–°</h2>
<p>æ–¹æ³•ä¸€çš„é—®é¢˜åœ¨äºï¼ŒskipWaiting ä¹‹åå¯¼è‡´ä¸€ä¸ªé¡µé¢å…ˆåè¢«ä¸¤ä¸ª SW æ§åˆ¶ã€‚é‚£æ—¢ç„¶å·²ç»å®‰è£…äº†æ–°çš„ SWï¼Œåˆ™è¡¨ç¤ºè€çš„ SW å·²ç»è¿‡æ—¶ï¼Œå› æ­¤å¯ä»¥æ¨æ–­ä½¿ç”¨è€çš„ SW å¤„ç†è¿‡çš„é¡µé¢ä¹Ÿå·²ç»è¿‡æ—¶ã€‚æˆ‘ä»¬è¦åšçš„æ˜¯è®©é¡µé¢ä»å¤´åˆ°å°¾éƒ½è®©æ–°çš„ SW å¤„ç†ï¼Œå°±èƒ½å¤Ÿä¿æŒä¸€è‡´ï¼Œä¹Ÿèƒ½è¾¾æˆæˆ‘ä»¬çš„éœ€æ±‚äº†ã€‚æ‰€ä»¥æˆ‘ä»¬æƒ³åˆ°äº†åˆ·æ–°ï¼ŒåºŸå¼ƒæ‰å·²ç»è¢«å¤„ç†è¿‡çš„é¡µé¢ã€‚</p>
<p>åœ¨æ³¨å†Œ SW çš„åœ°æ–¹ï¼ˆè€Œä¸æ˜¯ SW é‡Œé¢ï¼‰å¯ä»¥é€šè¿‡ç›‘å¬ <code>controllerchange</code> äº‹ä»¶æ¥å¾—çŸ¥æ§åˆ¶å½“å‰é¡µé¢çš„ SW æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">navigator.serviceWorker.addEventListener(&#39;controllerchange&#39;, () =&gt; {
  window.location.reload();
})
å¤åˆ¶ä»£ç 
</code></pre></td></tr></table>
</div>
</div><p>å½“å‘ç°æ§åˆ¶è‡ªå·±çš„ SW å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£å°±åˆ·æ–°è‡ªå·±ï¼Œè®©è‡ªå·±ä»å¤´åˆ°å°¾éƒ½è¢«æ–°çš„ SW æ§åˆ¶ï¼Œå°±ä¸€å®šèƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚é“ç†æ˜¯å¯¹ï¼Œä½†çªç„¶çš„æ›´æ–°ä¼šæ‰“æ–­ç”¨æˆ·çš„æ“ä½œï¼Œå¯èƒ½ä¼šå¼•å‘ä¸é€‚ã€‚åˆ·æ–°çš„æºå¤´åœ¨äº SW çš„å˜æ›´ï¼›SW çš„å˜æ›´åˆæ¥æºäºæµè§ˆå™¨å®‰è£…æ–°çš„ SW ç¢°ä¸Šäº† <code>skipWaiting</code>ï¼Œæ‰€ä»¥è¿™æ¬¡åˆ·æ–°ç»å¤§éƒ¨åˆ†æƒ…å†µä¼šå‘ç”Ÿåœ¨åŠ è½½é¡µé¢åçš„å‡ ç§’å†…ã€‚ç”¨æˆ·åˆšå¼€å§‹æµè§ˆå†…å®¹æˆ–è€…å¡«å†™ä¿¡æ¯å°±é‡ä¸Šäº†è«åçš„åˆ·æ–°ï¼Œå¯èƒ½ä¼šç ¸é”®ç›˜ã€‚</p>
<p>å¦å¤–è¿™é‡Œè¿˜æœ‰ä¸¤ä¸ªæ³¨æ„ç‚¹ï¼š</p>
<h3 id="sw-çš„æ›´æ–°å’Œé¡µé¢çš„åˆ·æ–°">SW çš„æ›´æ–°å’Œé¡µé¢çš„åˆ·æ–°</h3>
<p>åœ¨è®²åˆ° SW çš„ waiting çŠ¶æ€æ—¶ï¼Œæˆ‘æ›¾ç»è¯´è¿‡ <strong>ç®€å•çš„åˆ‡æ¢é¡µé¢æˆ–è€…åˆ·æ–°æ˜¯ä¸èƒ½ä½¿å¾— SW è¿›è¡Œæ›´æ–°çš„</strong>ï¼Œè€Œè¿™é‡Œåˆä¸€æ¬¡ç‰µæ¶‰åˆ°äº† SW çš„æ›´æ–°å’Œé¡µé¢çš„åˆ·æ–°ï¼Œä¸å…äº§ç”Ÿæ··æ·†ã€‚</p>
<p>æˆ‘ä»¬ç®€å•ç†ä¸€ä¸‹é€»è¾‘ï¼Œå…¶å®ä¹Ÿä¸å¤æ‚ï¼š</p>
<ol>
<li>åˆ·æ–°ä¸èƒ½ä½¿å¾— SW å‘ç”Ÿæ›´æ–°ï¼Œå³è€çš„ SW ä¸ä¼šé€€å‡ºï¼Œæ–°çš„ SW ä¹Ÿä¸ä¼šæ¿€æ´»ã€‚</li>
<li>è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡ <code>skipWaiting</code> è¿«ä½¿ SW æ–°è€äº¤æ›¿ã€‚åœ¨äº¤æ›¿å®Œæˆåï¼Œé€šè¿‡ <code>controllerchange</code> ç›‘å¬åˆ°å˜åŒ–å†æ‰§è¡Œåˆ·æ–°ã€‚</li>
</ol>
<p>æ‰€ä»¥ä¸¤è€…çš„å› æœæ˜¯ç›¸åçš„ï¼Œå¹¶ä¸çŸ›ç›¾ã€‚</p>
<h3 id="é¿å…æ— é™åˆ·æ–°">é¿å…æ— é™åˆ·æ–°</h3>
<p>åœ¨ä½¿ç”¨ Chrome Dev Tools çš„ Update on Reload åŠŸèƒ½æ—¶ï¼Œä½¿ç”¨å¦‚ä¸Šä»£ç ä¼šå¼•å‘æ— é™çš„è‡ªæˆ‘åˆ·æ–°ã€‚ä¸ºäº†å¼¥è¡¥è¿™ä¸€ç‚¹ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ª flag åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">let refreshing = false
navigator.serviceWorker.addEventListener(&#39;controllerchange&#39;, () =&gt; {
  if (refreshing) {
    return
  }
  refreshing = true;
  window.location.reload();
});
å¤åˆ¶ä»£ç 
</code></pre></td></tr></table>
</div>
</div><h2 id="æ–¹æ³•ä¸‰ç»™ç”¨æˆ·ä¸€ä¸ªæç¤º">æ–¹æ³•ä¸‰ï¼šç»™ç”¨æˆ·ä¸€ä¸ªæç¤º</h2>
<p>æ–¹æ³•äºŒæœ‰ä¸€ä¸ªæ€è·¯å€¼å¾—å€Ÿé‰´ï¼Œå³â€œé€šè¿‡ SW çš„å˜åŒ–è§¦å‘äº‹ä»¶ï¼Œè€Œåœ¨äº‹ä»¶ç›‘å¬ä¸­æ‰§è¡Œåˆ·æ–°â€ã€‚ä½†æ¯«æ— å¾å…†çš„åˆ·æ–°é¡µé¢çš„ç¡®ä¸å¯æ¥å—ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æ”¹è¿›ä¸€ä¸‹ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªæç¤ºï¼Œè®©ä»–æ¥ç‚¹å‡»åæ›´æ–° SWï¼Œå¹¶å¼•å‘åˆ·æ–°ï¼Œå²‚ä¸ç¾å“‰ï¼Ÿ</p>
<p>å¤§è‡´çš„æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>æµè§ˆå™¨æ£€æµ‹åˆ°å­˜åœ¨æ–°çš„ï¼ˆä¸åŒçš„ï¼‰SW æ—¶ï¼Œå®‰è£…å¹¶è®©å®ƒç­‰å¾…ï¼ŒåŒæ—¶è§¦å‘ <code>updatefound</code> äº‹ä»¶</li>
<li>æˆ‘ä»¬ç›‘å¬äº‹ä»¶ï¼Œå¼¹å‡ºä¸€ä¸ªæç¤ºæ¡ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯ä¸æ˜¯è¦æ›´æ–° SW</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://user-gold-cdn.xitu.io/2019/3/8/1695b072d6c04a82?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"
        data-srcset="https://user-gold-cdn.xitu.io/2019/3/8/1695b072d6c04a82?imageView2/0/w/1280/h/960/format/webp/ignore-error/1, https://user-gold-cdn.xitu.io/2019/3/8/1695b072d6c04a82?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 1.5x, https://user-gold-cdn.xitu.io/2019/3/8/1695b072d6c04a82?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 2x"
        data-sizes="auto"
        alt="https://user-gold-cdn.xitu.io/2019/3/8/1695b072d6c04a82?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"
        title="æç¤ºæ¡" /></p>
<ol>
<li>å¦‚æœç”¨æˆ·ç¡®è®¤ï¼Œåˆ™å‘å¤„åœ¨ç­‰å¾…çš„ SW å‘é€æ¶ˆæ¯ï¼Œè¦æ±‚å…¶æ‰§è¡Œ <code>skipWaiting</code> å¹¶å–å¾—æ§åˆ¶æƒ</li>
<li>å› ä¸º SW çš„å˜åŒ–è§¦å‘ <code>controllerchange</code> äº‹ä»¶ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªäº‹ä»¶çš„å›è°ƒä¸­åˆ·æ–°é¡µé¢å³å¯</li>
</ol>
<p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ç¬¬ 3 æ­¥ã€‚å› ä¸ºç”¨æˆ·ç‚¹å‡»çš„å“åº”ä»£ç æ˜¯ä½äºæ™®é€šçš„ JS ä»£ç ä¸­ï¼Œè€Œ <code>skipWaiting</code> çš„è°ƒç”¨ä½äº SW çš„ä»£ç ä¸­ï¼Œå› æ­¤è¿™ä¸¤è€…è¿˜éœ€è¦ä¸€æ¬¡ <code>postMessage</code> è¿›è¡Œé€šè®¯ã€‚</p>
<p>ä»£ç æ–¹é¢ï¼Œæˆ‘ä»¬ä»¥ Lavas çš„å®ç°æ¥åˆ†æ­¥éª¤çœ‹ä¸€ä¸‹ï¼š</p>
<p>ç¬¬ 1 æ­¥æ˜¯æµè§ˆå™¨æ‰§è¡Œçš„ï¼Œä¸æˆ‘ä»¬æ— å…³ã€‚ç¬¬ 2 æ­¥éœ€è¦æˆ‘ä»¬ç›‘å¬è¿™ä¸ª <code>updatefound</code> äº‹ä»¶ï¼Œè¿™æ˜¯éœ€è¦é€šè¿‡æ³¨å†Œ SW æ—¶è¿”å›çš„ Registration å¯¹è±¡æ¥ç›‘å¬çš„ï¼Œå› æ­¤é€šå¸¸æˆ‘ä»¬å¯ä»¥åœ¨æ³¨å†Œæ—¶ç›´æ¥ç›‘å¬ï¼Œé¿å…åç»­è¿˜è¦å†å»è·å–è¿™ä¸ªå¯¹è±¡ï¼Œå¾’å¢å¤æ‚ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">function emitUpdate() {
  var event = document.createEvent(&#39;Event&#39;);
  event.initEvent(&#39;sw.update&#39;, true, true);
  window.dispatchEvent(event);
}

if (&#39;serviceWorker&#39; in navigator) {
  navigator.serviceWorker.register(&#39;/service-worker.js&#39;).then(function (reg) {
    if (reg.waiting) {
      emitUpdate();
      return;
    }

    reg.onupdatefound = function () {
      var installingWorker = reg.installing;
      installingWorker.onstatechange = function () {
        switch (installingWorker.state) {
          case &#39;installed&#39;:
            if (navigator.serviceWorker.controller) {
              emitUpdate();
            }
            break;
        }
      };
    };
  }).catch(function(e) {
    console.error(&#39;Error during service worker registration:&#39;, e);
  });
}
å¤åˆ¶ä»£ç 
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡å‘é€ä¸€ä¸ªäº‹ä»¶ (åä¸º <code>sw.update</code>ï¼Œä½äº <code>emitUpdate()</code> æ–¹æ³•å†…) æ¥é€šçŸ¥å¤–éƒ¨ï¼Œè¿™æ˜¯å› ä¸ºæç¤ºæ¡æ˜¯ä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶ï¼Œä¸æ–¹ä¾¿åœ¨è¿™é‡Œç›´æ¥å±•ç°ã€‚å½“ç„¶å¦‚æœä½ çš„åº”ç”¨æœ‰ä¸åŒçš„ç»“æ„ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œä¿®æ”¹ã€‚æ€»ä¹‹æƒ³åŠæ³•å±•ç¤ºæç¤ºæ¡ï¼Œæˆ–è€…å•çº¯ä½¿ç”¨ <code>confirm</code> è®©ç”¨æˆ·ç¡®è®¤å³å¯ã€‚</p>
<p>ç¬¬ 3 æ­¥éœ€è¦å¤„ç†ç”¨æˆ·ç‚¹å‡»ï¼Œå¹¶å’Œ SW è¿›è¡Œé€šè®¯ã€‚å¤„ç†ç‚¹å‡»çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸é‡å¤äº†ï¼Œè¿™é‡Œä¸»è¦åˆ—å‡ºå’Œ SW çš„é€šè®¯ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">try {
  navigator.serviceWorker.getRegistration().then(reg =&gt; {
    reg.waiting.postMessage(&#39;skipWaiting&#39;);
  });
} catch (e) {
  window.location.reload();
}
å¤åˆ¶ä»£ç 
</code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„é€šè¿‡ <code>reg.waiting</code> å‘ <strong>ç­‰å¾…ä¸­çš„</strong> SW å‘æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯å‘å½“å‰çš„è€çš„ SW å‘æ¶ˆæ¯ã€‚è€Œ SW éƒ¨åˆ†åˆ™è´Ÿè´£æ¥æ”¶æ¶ˆæ¯ï¼Œå¹¶æ‰§è¡Œâ€œæ’é˜Ÿâ€é€»è¾‘ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// service-worker.js
// SW ä¸å†åœ¨ install é˜¶æ®µæ‰§è¡Œ skipWaiting äº†
self.addEventListener(&#39;message&#39;, event =&gt; {
  if (event.data === &#39;skipWaiting&#39;) {
    self.skipWaiting();
  }
})
å¤åˆ¶ä»£ç 
</code></pre></td></tr></table>
</div>
</div><p>ç¬¬ 4 æ­¥å’Œæ–¹æ³•äºŒä¸€è‡´ï¼Œä¹Ÿæ˜¯é€šè¿‡ <code>navigator.serviceWorker</code> ç›‘å¬ <code>controllerchange</code> äº‹ä»¶æ¥æ‰§è¡Œåˆ·æ–°æ“ä½œï¼Œè¿™é‡Œå°±ä¸é‡å¤åˆ—å‡ºä»£ç äº†ã€‚</p>
<h2 id="æ–¹æ³•ä¸‰çš„å¼Šç«¯">æ–¹æ³•ä¸‰çš„å¼Šç«¯</h2>
<p>ä»è¿è¡Œç»“æœä¸Šçœ‹ï¼Œè¿™ä¸ªæ–¹æ³•å…¼é¡¾äº†å¿«é€Ÿæ›´æ–°å’Œç”¨æˆ·ä½“éªŒï¼Œæ˜¯å½“å‰æœ€å¥½çš„è§£å†³æ–¹æ¡ˆã€‚ä½†å®ƒä¹Ÿæœ‰å¼Šç«¯ã€‚</p>
<h3 id="å¼Šç«¯ä¸€è¿‡äºå¤æ‚">å¼Šç«¯ä¸€ï¼šè¿‡äºå¤æ‚</h3>
<ul>
<li>åœ¨æ–‡ä»¶æ•°é‡æ–¹é¢ï¼Œæ¶‰åŠåˆ°è‡³å°‘ 2 ä¸ªæ–‡ä»¶ï¼ˆæ³¨å†Œ SWï¼Œç›‘å¬ <code>updatefound</code> å’Œå¤„ç† DOM çš„å±•ç°å’Œç‚¹å‡»åœ¨æ™®é€šçš„ JS ä¸­ï¼Œç›‘å¬ä¿¡æ¯å¹¶æ‰§è¡Œ <code>skipWaiting</code> æ˜¯åœ¨ SW çš„ä»£ç ä¸­ï¼‰ï¼Œè¿™è¿˜ä¸ç®—æˆ‘ä»¬å¯èƒ½ä¸ºäº†ä»£ç çš„æ¨¡å—åˆ†ç¦»ï¼ŒæŠŠ DOM çš„å±•ç°ç‚¹å‡»å’Œ SW çš„æ³¨å†Œåˆ†æˆä¸¤ä¸ªæ–‡ä»¶</li>
<li>åœ¨ API ç§ç±»æ–¹é¢ï¼Œæ¶‰åŠåˆ° Registration APIï¼ˆæ³¨å†Œï¼Œç›‘å¬ <code>updatefound</code> å’Œå‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨ï¼‰ï¼ŒSW ç”Ÿå‘½å‘¨æœŸå’Œ APIï¼ˆ<code>skipWaiting</code>ï¼‰ä»¥åŠæ™®é€šçš„ DOM API</li>
<li>æµ‹è¯•å’Œ DEBUG æ–¹æ³•å¤æ‚ï¼Œè‡³å°‘éœ€è¦åˆ¶é€ æ–°è€ 2 ä¸ªç‰ˆæœ¬ SW çš„ç¯å¢ƒï¼Œå¹¶ä¸”ç†Ÿç»ƒæŒæ¡ SW çš„ DEBUG æ–¹å¼ã€‚</li>
</ul>
<p>å°¤å…¶æ˜¯ä¸ºäº†è¾¾æˆç”¨æˆ·ç‚¹å‡»åçš„ SW â€œæ’é˜Ÿâ€ï¼Œéœ€è¦ä» DOM ç‚¹å‡»å“åº”ï¼Œåˆ°å‘é€æ¶ˆæ¯ç»™ SWï¼Œå†åˆ° SW é‡Œé¢æ“ä½œã€‚è¿™ä¸€ä¸²æ“ä½œæ¨ªè·¨å¥½å‡ ä¸ª JSï¼Œéå¸¸ä¸ç›´è§‚ä¸”å¤æ‚ã€‚ä¸ºæ­¤å·²æœ‰ Google å¤§ä½¬ Jake Archibald å‘ W3C æå‡º<a href="https://github.com/w3c/ServiceWorker/issues/1016" target="_blank" rel="noopener noreffer">å»ºè®®</a>ï¼Œç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œå…è®¸åœ¨æ™®é€šçš„ JS ä¸­é€šè¿‡ <code>reg.waiting.skipWaiting()</code> ç›´æ¥æ’é˜Ÿï¼Œè€Œä¸æ˜¯åªèƒ½åœ¨ SW å†…éƒ¨æ“ä½œã€‚</p>
<h3 id="å¼Šç«¯äºŒå¿…é¡»é€šè¿‡-js-å®Œæˆæ›´æ–°">å¼Šç«¯äºŒï¼šå¿…é¡»é€šè¿‡ JS å®Œæˆæ›´æ–°</h3>
<p>è¿™é‡ŒæŒ‡çš„æ˜¯ SW çš„æ›´æ–°åªèƒ½é€šè¿‡ç”¨æˆ·ç‚¹å‡»é€šçŸ¥æ¡ä¸Šçš„æŒ‰é’®ï¼Œä½¿ç”¨ JS æ¥å®Œæˆï¼Œè€Œ <strong>ä¸èƒ½é€šè¿‡æµè§ˆå™¨çš„åˆ·æ–°æŒ‰é’®å®Œæˆ</strong>ã€‚è¿™å…¶å®æ˜¯æµè§ˆå™¨çš„è®¾è®¡é—®é¢˜ï¼Œè€Œéæ–¹æ¡ˆæœ¬èº«çš„é—®é¢˜ã€‚</p>
<p>ä¸è¿‡åè¿‡æ¥è¯´ï¼Œå¦‚æœæµè§ˆå™¨å¸®åŠ©æˆ‘ä»¬å®Œæˆäº†ä¸Šè¿°æ“ä½œï¼Œé‚£å°±å˜æˆå…è®¸é€šè¿‡ä¸€ä¸ª Tab çš„åˆ·æ–°å»å¼ºåˆ¶å…¶ä»– Tab åˆ·æ–°ï¼Œåœ¨å½“å‰æµè§ˆå™¨ä»¥ Tab ä¸ºå•ä½çš„å‰æä¸‹ï¼Œå­˜åœ¨è¿™ç§äº¤å‰æ§åˆ¶ä¹Ÿæ˜¯ä¸å®‰å…¨å’Œéš¾ä»¥ç†è§£çš„ã€‚</p>
<p>å”¯ä¸€å¯è¡Œçš„ä¼˜åŒ–æ˜¯å½“ SW æ§åˆ¶çš„é¡µé¢ä»…å­˜åœ¨ä¸€ä¸ª Tab æ—¶ï¼Œåˆ·æ–°è¿™ä¸ª Tab å¦‚æœèƒ½å¤Ÿæ›´æ–° SWï¼Œä¹Ÿèƒ½ç»™æˆ‘ä»¬çœå»ä¸å°‘æ“ä½œï¼Œä¹Ÿä¸ä¼šå¸¦æ¥äº¤å‰æ§åˆ¶çš„é—®é¢˜ã€‚åªæ˜¯è¿™æ ·å¯èƒ½åŠ é‡äº†æµè§ˆå™¨çš„åˆ¤æ–­æˆæœ¬ï¼Œä¹Ÿä¸§å¤±äº†æ“ä½œä¸€è‡´æ€§çš„ç¾æ„Ÿï¼Œåªèƒ½è¯´è¿™å¯èƒ½ä¹Ÿæ˜¯ä¸€ä¸ªä¹…è¿œçš„æ¢¦æƒ³äº†ã€‚</p>
<h2 id="åè®°">åè®°</h2>
<p>SW çš„åŠŸèƒ½ç›¸å½“å¼ºå¤§ï¼Œä½†åŒæ—¶æ¶‰åŠçš„ API ä¹Ÿç›¸å¯¹è¾ƒå¤šï¼Œæ˜¯ä¸€ä¸ªéœ€è¦æŠ•å…¥ç›¸å½“å­¦ä¹ æˆæœ¬çš„å¼ºåŠ›æŠ€æœ¯ï¼ˆå›½å¤–æ–‡ç« ç§°ä¹‹ä¸º rocket scienceï¼‰ã€‚SW çš„æ›´æ–°å¯¹ä½¿ç”¨ SW çš„ç«™ç‚¹æ¥è¯´éå¸¸é‡è¦ï¼Œä½†å¦‚ä¸Šæ‰€è¿°ï¼Œå…¶æ–¹æ¡ˆä¹Ÿç›¸å¯¹å¤æ‚ï¼Œè¿œè¿œè¶…è¿‡äº†å…¶ä»–å¸¸ç”¨å‰ç«¯åŸºç¡€æŠ€æœ¯çš„å¤æ‚åº¦ï¼ˆä¾‹å¦‚ DOM APIï¼ŒJS è¿ç®—ï¼Œé—­åŒ…ç­‰ç­‰ï¼‰ã€‚ä¸è¿‡ SW ä»å…¶èµ·æ­¥è‡³ä»Šä¹Ÿä¸è¿‡ä¸¤ä¸‰å¹´çš„æ—¶é—´ï¼Œå°šå¤„åœ¨å‘å±•æœŸã€‚ç›¸ä¿¡é€šè¿‡ W3C çš„ä¸æ–­ä¿®æ­£ä»¥åŠå‰ç«¯åœˆçš„æŒç»­ä½¿ç”¨ï¼Œä¼šæœ‰æ›´åŠ ç®€æ´ï¼Œæ›´åŠ è‡ªåŠ¨ï¼Œæ›´åŠ å®Œå¤‡çš„æ–¹æ¡ˆå‡ºç°ï¼Œå±Šæ—¶æˆ‘ä»¬å¯èƒ½å°±èƒ½åƒä½¿ç”¨ DOM API é‚£æ ·ç®€å•åœ°ä½¿ç”¨ SW äº†ã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h2>
<ul>
<li><a href="https://github.com/lavas-project/lavas/issues/212" target="_blank" rel="noopener noreffer">æœ‰å…³ Service Worker æ›´æ–°çš„ä¸¤ç‚¹æ”¹è¿›</a> - ç¼–å†™æœ¬æ–‡çš„æºå¤´</li>
<li><a href="https://developers.google.com/web/fundamentals/primers/service-workers/lifecycle" target="_blank" rel="noopener noreffer">The Service Worker Lifecycle</a> - æ¥è‡ª Google Developers çš„ Service Worker ç§‘æ™®æ–‡ç« ä¹‹ä¸€</li>
<li><a href="https://redfin.engineering/how-to-fix-the-refresh-button-when-using-service-workers-a8e27af6df68" target="_blank" rel="noopener noreffer">How to Fix the Refresh Button When Using Service Workers</a> - æåŠäº†ç¬¬å››ç§æ–¹æ³•ï¼Œä¸è¿‡åœ¨ Firefox ä¸­ä»æœ‰å…¼å®¹æ€§é—®é¢˜</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2021-06-09</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/service-worker-update/index.md" target="_blank">é˜…è¯»åŸå§‹æ–‡æ¡£</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="åˆ†äº«åˆ° Twitter" data-sharer="twitter" data-url="https://radish.cloud/posts/service-worker-update/" data-title="[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•" data-hashtags="service worker,pwa"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Line" data-sharer="line" data-url="https://radish.cloud/posts/service-worker-update/" data-title="[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° å¾®åš" data-sharer="weibo" data-url="https://radish.cloud/posts/service-worker-update/" data-title="[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•" data-ralateuid="1910759497"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° ç™¾åº¦" data-sharer="baidu" data-url="https://radish.cloud/posts/service-worker-update/" data-title="[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•"><i data-svg-src="/lib/simple-icons/icons/baidu.min.svg"></i></a><a href="javascript:void(0);" title="åˆ†äº«åˆ° Evernote" data-sharer="evernote" data-url="https://radish.cloud/posts/service-worker-update/" data-title="[è½¬]å¤„ç†service worker æ›´æ–°çš„å¸¸ç”¨æ–¹æ³•"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/service-worker/">service worker</a>,&nbsp;<a href="/tags/pwa/">pwa</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/anhlaidh%E7%9A%84java%E7%AC%94%E8%AE%B01/" class="prev" rel="prev" title="Anhlaidhçš„javaç¬”è®°1"><i class="fas fa-angle-left fa-fw"></i>Anhlaidhçš„javaç¬”è®°1</a>
            <a href="/posts/ff14-cartoon/" class="next" rel="next" title="ã€è¡¥æ¡£ã€‘èåœçš„ç‹’ç‹’å›½é™…æœæ¼«ç”»">ã€è¡¥æ¡£ã€‘èåœçš„ç‹’ç‹’å›½é™…æœæ¼«ç”»<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments" style="padding: 4rem 0 2rem!important;"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><script>
    NProgress.configure({ easing: 'ease', speed: 300 ,showSpinner: false,parent:'html'});
    NProgress.start();
    var porcessTimer = setInterval(function() {
        NProgress.inc()
    }, 200);
    window.addEventListener("load",(e)=>{
        NProgress.done(true);
        clearInterval(porcessTimer)
        console.log("æµ‹è¯•")
    })
</script>

    <footer class="footer">
        
        <div class="footer-container">
        
            <div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2018 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">èåœç‚–é±¼ä¸¸</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><a href='https://beian.miit.gov.cn/'>è’™ICPå¤‡14003205å·</a></span></div><div class="footer-line">ç«™ç‚¹éƒ¨ç½²äº<b><a href="//pages.github.com">GIthub Pages</a></b>ï¼Œç”±<b><a href="//cloudflare.com">Cloudflare</b></b>æä¾›åŠ é€Ÿ</div><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.83.1">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div></br>
            
        </div>
        
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/foo.css"><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript" src="/js/tata.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":10},"comment":{"valine":{"appId":"nzQD1VSNO15t41r81iycjyxG-gzGzoHsz","appKey":"IsoxHJmeJAdEAei7Sa8ieCXX","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":true,"friends":"['e97c4596bd7a14be7ad753c6fa3d9eee','b989d53c59f5ff07295b89bafcb0631f']","highlight":true,"lang":"zh-cn","master":"a197ee9af986201f1482413a5f37f54a","pageSize":10,"placeholder":"æ˜µç§°å¡«å†™qqå¯ä»¥æ˜¾ç¤ºqqå¤´åƒå’Œæ˜µç§°å“¦~","recordIP":false,"serverURLs":"https://comment.radish.cloud","visitor":true}},"cookieconsent":{"content":{"dismiss":"åŒæ„","link":"äº†è§£æ›´å¤š","message":"æœ¬ç½‘ç«™ä½¿ç”¨ Cookies æ¥æ”¹å–„æ‚¨çš„æµè§ˆä½“éªŒ."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js"></script>

<script> $(function () {
                $(".site-avatar-plug-bilibili").attr("src", "\/images\/avatar-plug\/asoul_1.png");
            }); 
        var avatar_plug = 0;
        var avatar_click = 1;
        jQuery(document).ready(function($) {
             
            var frequency =  1 ;
             
            var plug_count =  128 ;
            $("div.home-avatar a").click(function(e) {
                if (avatar_click % frequency === 0) {
                    avatar_plug ++;
                    $(".site-avatar-plug-bilibili").attr("src", "/images/avatar-plug/bilibili_" + avatar_plug + ".png");
                }		
                if (avatar_plug === plug_count) {
                    avatar_plug = 0;
                }
                $("div.home-avatar a").attr("alt","å†ç‚¹å‡»" + (frequency - avatar_click % frequency) + "æ¬¡å¤´åƒè¯•è¯•çœ‹~~");
                avatar_click ++;
            });
        });</script>

<script src="/foo.js"></script>


<script type="module">
    import { Workbox } from '/workbox-window.prod.mjs'

    console.log("loading Customer Javascript file...")

    let flag = false;

    function createUIPrompt(opts) {
        tata.info("æ£€æµ‹åˆ°æ–°çš„æ›´æ–°", "<a id='update' style='color:#455760;' href='javascript:void(0);'>ç‚¹å‡»æ­¤å¤„è¿›è¡Œæ›´æ–°<a>", {
            position: "bm",
            duration: 8000,
            animate:"slide"

        })
        document.getElementById("update").addEventListener("click", () => {
            flag = true
            if (flag) {
                opts.onAccept();
                tata.success('æ›´æ–°æˆåŠŸ', 'é¡µé¢å³å°†åˆ·æ–°', {
                    holding: true,
                    position: "bm"
                })
            }
        })
    }

    if ('serviceWorker' in navigator) {
        const wb = new Workbox('/sw.js');
        let registration;

        const showSkipWaitingPrompt = (event) => {
            
            
            
            
            

            
            
            const prompt = createUIPrompt({
                onAccept: () => {
                    
                    
                    
                    wb.addEventListener('controlling', (event) => {
                        window.location.reload();
                    });

                    wb.messageSkipWaiting();
                },

                onReject: () => {
                    prompt.dismiss();
                }
            });
        };

        
        
        wb.addEventListener('waiting', showSkipWaitingPrompt);

        wb.register();
    }
</script></body>
</html>
